# TRPG AIエージェントGMプロジェクト - 仕様変更書

## 1. 技術スタック変更点

### インフラストラクチャ
- **デプロイ先**: Google Cloud Run に変更
- **ストレージ**: Cloud Storage（画像ファイル用）
- **データベース**: Litestream を採用

## 2. 画面機能の変更内容

### 2.1 あらすじ画面
- **変更点**: TRPGセッション用システムプロンプトに特化
- **目的**: シナリオの全体設定とTRPG世界観の設定

### 2.2 プロット画面
- **変更点**: 大まかな日程プロットに変更
- **内容**: 「X日目に～～が起きる」形式でイベントを定義
- **用途**: セッション進行の骨格を提供

### 2.3 キャラクター画面
- **変更点**: パーティ編成画面に改修
- **機能**:
  - 新規キャラクター追加
  - シナリオ許容人数内でのキャラクター設定
  - TRPGステータス形式への変更（`docs/キャラクター.md`参照）
  - AIエージェントによるキャラクターイメージ画像生成機能

### 2.4 執筆画面
- **変更点**: TRPGゲーミング用フロントエンドに全面改修
- **詳細**: 後述のTRPGセッション画面として実装

### 2.5 タイムライン画面
- **変更点**: 年単位から日単位の時間軸に変更
- **レイアウト**: 1日目～X日目（ユーザー設定可能）
- **機能**:
  - 敵キャラクターの場所・日程固定配置
  - 同一時間・場所での戦闘発生システム

### 2.6 世界観構築画面
- **変更点**: ワールド設定画面に改修
- **機能**:
  - 大まかな世界設定
  - 拠点情報の設定（`拠点.md`参照）
  - 拠点画像の設定
  - AIエージェントによる拠点画像生成機能
- **ゲーム連携**: 拠点にいる非操作キャラクターの立ち絵表示

## 3. 新機能の追加

### 3.1 キャラクター相互作用システム
- **型定義**: キャラクター実行イベント型を新規追加
- **機能**:
  - キャラクター間での影響行動
  - HP減少、状態異常回復・付与など
  - 対象への直接的な効果適用

### 3.2 開発モード切り替え機能
- **場所**: 設定タブに開発者モード切り替えスイッチを追加
- **デフォルト**: オフ状態
- **オフ時の表示**:
  - ゲーム開始前: パーティ設定とTRPGセッション移行のみ
  - ゲーム開始後: 設定タブとAIChatパネルが非表示
- **オン時**: 全設定項目が表示可能

## 4. 新規画面の実装

### 4.1 TRPGセッション画面
#### 概要
- **ワイヤーフレーム**: `docs/UI考案.png`参照
- **目的**: TRPGシナリオプレイのメイン画面

#### ゲーム進行フロー
1. **開始時**: キャラクター選択→ゲーム開始
2. **導入**: AIエージェントからのゲーム解説
3. **行動選択**: エージェント提供の選択肢から選択
4. **行動内容**:
   - 移動（街・拠点間）
   - 買い物
   - NPC会話
   - キャラクター間相互作用
5. **日程進行**: イベント完了条件達成または行動回数上限で次日へ

#### UI構成要素
- **イラスト表示**: プロジェクト定義からURL取得
- **インタラクト機能**:
  - **ダイスロールUI**: 攻撃威力・イベント成功判定
  - **スキルチェックUI**: 円形ゲージの緑ゾーン停止ゲーム
  - **パワーチェック**: 連打による成功・失敗判定
- **チャット機能**: 日付指定でのログ遡及機能
- **キャラクター表示**: 参加全キャラクターの常時表示
- **装備・スキル表示**: 操作キャラクターの詳細情報

### 4.2 敵キャラクター定義画面
- **体力設定**: プレイヤーキャラクターより少なめ
- **型定義**: `docs/エネミー.md`参照
- **クラス分類**:
  - **モブ**: 基本的な敵
  - **エネミーリーダー**: 中級の敵
  - **ボス**: 全キャラクター協力必須の強敵
- **AI制御**: 行動パターンはAIエージェントが決定

### 4.3 NPC設定画面
- **基本機能**: 街での定型文章提供
- **AI制御**: 返答内容と行動はAIエージェントが生成

## 5. 今後の実装課題

### 5.1 ユーザー認証・サーバーサイド実装
- **マルチプレイヤーモード**: TRPG複数人プレイ対応
- **課金システム**: チケット制（1プレイ200円想定）
- **収益分配**: ユーザー作成シナリオの作者還元（60%想定）
- **拡散促進**: ユーザー生成コンテンツによるエコシステム構築

## 6. 参考ドキュメント
- `docs/キャラクター.md` - TRPGキャラクターステータス仕様
- `docs/拠点.md` - 拠点情報設定仕様  
- `docs/エネミー.md` - 敵キャラクター型定義
- `docs/UI考案.png` - TRPGセッション画面ワイヤーフレーム