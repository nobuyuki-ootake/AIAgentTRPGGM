# TRPG セッション機能テストガイド

## 概要

このドキュメントは、TRPG セッション機能のテストを効率的に実行するためのガイドです。

## 前提条件

### 1. サーバー起動確認

```bash
# フロントエンドサーバー（5173ポート）
pnpm dev

# プロキシサーバー（4001ポート）
cd apps/proxy-server && pnpm dev

# ポート使用状況確認
lsof -ti:5173  # フロントエンド
lsof -ti:4001  # プロキシサーバー

# ヘルスチェック
curl http://localhost:4001/health
```

### 2. 環境変数確認

```bash
# フロントエンド .env.local
VITE_API_BASE_URL=http://localhost:4001

# プロキシサーバー .env
PORT=4001
GEMINI_API_KEY=既に設定されている！！
```

## テスト手順

### ステップ 1: 初期画面の確認

1. `localhost:5173/trpg-session` にアクセス
2. **重要**: サイドバーを閉じる
   - 画面左側のサイドバーが開いている場合は、以下のいずれかの方法で閉じる：
     - **方法 1**: 折りたたみボタンをクリック - `data-testid="drawer-collapse-button"`（左向き矢印アイコン）
     - **方法 2**: バックドロップをクリック - `.MuiBackdrop-root`（サイドバー以外の暗い部分）
   - サイドバーが閉じていないと、デバッグボタンやその他の UI 要素がクリックできない場合がある
3. **重要**: デベロッパーモードを有効にする
   ```javascript
   // ブラウザのコンソールで実行
   localStorage.setItem("developerMode", "true");
   location.reload();
   ```
4. 初期状態の確認：
   - [ ] 「AI にセッションを始めてもらう」ボタンが表示される（「セッション進行中」ではない）
   - [ ] 「キャラクター未選択」の警告チップが表示される

### ステップ 2: テストデータロード

1. デバッグパネルを開く
   - **セレクター**: `[data-testid="debug-panel-button"]`（「Debug」ボタン）
2. 「🔄 JSON から再ロード」ボタンをクリック
   - **セレクター**: `text=🔄 JSONから再ロード`
3. 確認事項：
   - [ ] チャットエリアに「📊 データ詳細」メッセージが表示される
   - [ ] 左パネルに 3 人のキャラクター（アレックス、エルフィン、ライナ）が表示される
   - [ ] 右パネルの拠点タブに「リバーベント街」が表示される

### ステップ 3: キャラクター選択

1. 左パネルでアレックス・ブレイブハートをクリック
   - **セレクター**: `text=アレックス・ブレイブハート` または左パネルのキャラクター名部分をクリック
   - キャラクターカードの枠内であればどこでもクリック可能
2. 確認事項：
   - [ ] ヘッダーに「操作: アレックス・ブレイブハート」の緑チップが表示される
   - [ ] 「キャラクター未選択」警告チップが消える
   - [ ] 「AI にセッションを始めてもらう」ボタンが有効になる

### ステップ 4: セッション開始

1. 「AI にセッションを始めてもらう」ボタンをクリック
   - **セレクター**: `[data-testid="start-ai-session-button"]`
2. 確認事項：
   - [ ] ボタンが「セッション進行中」に変わる
   - [ ] チャットに「🎲 AI セッション開始！」メッセージが表示される
   - [ ] AI からの詳細なセッション開始メッセージが表示される（API エラーがなければ）

### ステップ 5: AI API エラーの対処

**症状**: チャットに「❌ AI API エラーが発生しました: Failed to fetch」が表示される場合
**原因**:

1. プロキシサーバーが起動していない
2. API キーが設定されていない
3. ネットワーク接続の問題

**解決方法**:

```bash
# 1. プロキシサーバーの状態確認
curl http://localhost:4001/health

# 2. プロキシサーバーの再起動
cd apps/proxy-server && pnpm dev

# 3. API キーの確認（ブラウザコンソールで実行）
localStorage.getItem('gemini-api-key')
```

## よくある問題と解決方法

### 1. CORS エラー

**症状**: コンソールに「CORS 要求が成功しなかった」エラー
**原因**: プロキシサーバーが起動していない
**解決**:

```bash
cd apps/proxy-server && pnpm dev
```

### 2. 「セッション進行中」が初期表示される

**症状**: キャラクター未選択なのに「セッション進行中」ボタンが表示
**原因**: `isSessionStarted`の自動設定バグ
**解決**: useTRPGSessionUI.ts の自動セッション開始コードを削除済み

### 3. テストデータが表示されない

**症状**: キャラクターや拠点が表示されない
**原因**: テストデータの型不整合
**解決**: testCampaignData.ts が本番型定義を使用することを確認

### 4. AI アピ接続エラー

**症状**: AI 応答生成時にネットワークエラー
**原因**: API キーが設定されていない、またはプロキシサーバーの問題
**確認**:

```bash
curl http://localhost:4001/health
# services.gemini が "configured" であることを確認
```

### 5. ⚠️ **新規追加**: ターンベース機能のテスト失敗パターン

#### 5-1. アクション選択 UI が表示されない

**症状**: AI セッション開始後にアクション選択ボタンが表示されない
**原因**: AI レスポンスからのアクション抽出が失敗
**確認ポイント**:

- AI レスポンスにアクション候補が含まれているか
- `extractActionsFromAIResponse`関数が正常動作しているか
- `setAvailableActions`が呼び出されているか

#### 5-2. AI 操作キャラクターが行動しない

**症状**: ユーザー行動選択後に AI 操作キャラクターの行動が開始されない
**原因**: ターン管理システムの状態不整合
**確認ポイント**:

- `turnState.awaitingCharacters`に非選択キャラクターの ID が含まれているか
- `processPlayerAction`でターン状態が正しく更新されているか

#### 5-3. ターン結果が生成されない

**症状**: 全員の行動完了後に AI からの結果説明が表示されない
**原因**: ターン完了検知の失敗または AI API 呼び出しエラー
**確認ポイント**:

- `checkTurnCompletion`が呼び出されているか
- `generateTurnSummary`で API エラーが発生していないか

## テスト結果の記録

### 最新テスト結果 (2025-06-07)

- ✅ キャラクター選択必須チェック機能
- ✅ セッション開始状態の修正
- ⚠️ AI セッション開始時の CORS 問題（調査中）

### 次回テスト時の注意点

1. プロキシサーバーの起動を最初に確認する
2. デベロッパーモードの有効化を忘れない
3. テストデータリロード後の状態確認を徹底する

## 機能実装状況

### 完了済み機能

- [x] キャラクター選択必須チェック
- [x] AI セッション開始時のアナウンス
- [ ] ユーザー行動選択 UI
- [ ] 非選択キャラクターの AI エージェント操作
- [ ] 全員操作完了後のターン進行
- [ ] AI ゲームマスターによる結果説明

### 実装予定機能

1. ユーザー行動選択 UI
   - アクションボタンの表示
   - チャット形式での行動入力
2. ターンベース処理
   - AI 操作キャラクターの自動行動
   - 全員行動完了の検知
   - ターン結果の AI 生成

## スクリーンショット保存場所

テスト時のスクリーンショットは以下に保存：

- `apps/frontend/test-screenshots/`
- ファイル名形式: `YYYY-MM-DD-test-name-step-N.png`
