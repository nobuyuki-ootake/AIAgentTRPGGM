# タイムライン画面機能定義

## 画面の目的と概要

タイムライン画面は、物語の時系列上の出来事を可視化・管理するためのインターフェースを提供します。ユーザーはこの画面で物語内のイベントを時間軸に沿って配置し、ストーリー全体の流れと出来事の前後関係を視覚的に把握することができます。

時間軸と場所を組み合わせた二次元のタイムラインにより、物語の時空間的な広がりを直感的に管理できます。また、キャラクターと場所を組み合わせたイベント設定により、「誰が」「いつ」「どこで」「何をしたか」を体系的に整理することができ、執筆時の整合性確保に役立ちます。

## 主要な機能一覧

1. **タイムライン表示機能**

   - 時間軸（水平方向）と場所（垂直方向）による二次元タイムライン表示
   - イベントのドラッグ＆ドロップによる時間・場所の調整
   - ズームイン/アウトによる時間範囲の調整
   - 時間軸のカスタマイズ（開始日・終了日の設定）

2. **イベント管理機能**

   - 新規イベントの追加
   - 既存イベントの編集・削除
   - イベント間の関連付け（因果関係など）
   - イベントの詳細情報（タイトル、説明、日付、関連キャラクター、関連場所など）の設定

3. **フィルタリング・検索機能**

   - キャラクター、場所、イベントタイプによるフィルタリング
   - 時間範囲指定によるイベント絞り込み
   - キーワード検索によるイベント検索

4. **ビジュアル表現機能**

   - キャラクターアイコンによるイベント表示
   - イベントタイプによる色分け
   - イベント重要度による表示サイズ変更
   - イベント間の関連線表示（オプション）

5. **データ連携機能**
   - キャラクター情報との連携
   - 場所情報（世界観構築）との連携
   - チャプター・シーンとの連携（執筆時の参照用）

## データ構造

主に以下のデータ構造を扱います：

```typescript
// タイムラインイベント
interface TimelineEvent {
  id: string;
  title: string;
  description: string;
  date: string; // ISO形式の日付
  relatedCharacters: string[]; // キャラクターIDの配列
  relatedPlaces: string[]; // 場所IDの配列
  importance?: number; // 重要度（1-5）
  type?: string; // イベントタイプ（任意）
  color?: string; // 表示色（任意）
  relatedEvents?: string[]; // 関連イベントIDの配列（任意）
}

// タイムラインの設定
interface TimelineSettings {
  startDate: string; // タイムライン表示開始日
  endDate?: string; // タイムライン表示終了日（任意）
  defaultViewMode: "day" | "week" | "month" | "year"; // デフォルト表示単位
  groupByPlace: boolean; // 場所でグループ化するかどうか
  customGroups?: TimelineGroup[]; // カスタムグループ設定（任意）
}

// タイムライングループ（縦軸の項目）
interface TimelineGroup {
  id: string;
  title: string;
  order: number; // 表示順
  type: "place" | "character" | "custom"; // グループの種類
  referenceId?: string; // 場所IDまたはキャラクターID（typeに応じて）
}
```

## ユーザーフロー

1. **タイムライン閲覧フロー**

   - タイムライン画面にアクセス
   - 時間範囲を調整（ズームイン/アウト）
   - 特定期間のイベントを確認
   - イベントをクリックして詳細を表示

2. **イベント作成フロー**

   - 「新規イベント追加」ボタンをクリック、または特定日時の位置でダブルクリック
   - イベント作成ダイアログが表示される
   - イベントタイトル、説明、日付、関連キャラクター、関連場所などを入力
   - 「保存」ボタンをクリックでイベントが追加される

3. **イベント編集フロー**

   - 既存イベントをクリックして選択
   - 「編集」ボタンをクリック
   - イベント編集ダイアログでデータを更新
   - 「保存」ボタンをクリックで変更が適用される
   - または、ドラッグ＆ドロップで日付や場所を直接変更

4. **フィルタリングフロー**
   - フィルターパネルを開く
   - キャラクター、場所、時間範囲などの条件を設定
   - 条件に合致するイベントのみが表示される
   - 「リセット」ボタンでフィルターをクリア

## 関連コンポーネント

- **TimelineVisualization**: タイムライン全体を表示する主要コンポーネント
- **TimelineEventItem**: 個別のイベントを表示するコンポーネント
- **TimelineEventDialog**: イベントの作成・編集用ダイアログ
- **TimelineControls**: ズーム、スクロール、表示モード切替などのコントロール
- **TimelineFilter**: フィルタリング用のコンポーネント
- **TimelineSettings**: タイムライン設定用のコンポーネント
- **TimelineEventDetails**: イベント詳細表示コンポーネント
- **CharacterSelector**: イベントに関連するキャラクター選択コンポーネント
- **PlaceSelector**: イベントに関連する場所選択コンポーネント

## 依存関係

- **useTimeline** フック: タイムライン管理のロジックを提供
- **currentProjectState** (Recoil): 現在選択されているプロジェクト状態
- **charactersState** (Recoil): キャラクター情報へのアクセス
- **worldBuildingState** (Recoil): 場所情報へのアクセス
- **LocalStorage**: タイムラインデータの永続化
- **タイムライン可視化ライブラリ**: react-calendar-timeline などの外部ライブラリ
- **moment.js/date-fns**: 日付操作ライブラリ
