# TRPG AI エージェント GM - Google Cloud Run デプロイガイド

## 概要

このドキュメントでは、TRPG AI エージェント GM プロジェクトを Google Cloud Run にデプロイする手順を説明します。

## アーキテクチャ構成

### インフラストラクチャ

- **フロントエンド**: React SPA (Cloud Run)
- **バックエンド**: Express.js API (Cloud Run)
- **データベース**: SQLite + Litestream (自動バックアップ)
- **ストレージ**: Google Cloud Storage (画像・データベースバックアップ)
- **AI 統合**: OpenAI, Anthropic Claude, Google Vertex AI

### サービス構成

```
trpg-frontend (Cloud Run)    ← ユーザーアクセス
     ↓
trpg-backend (Cloud Run)     ← API・AI処理
     ↓
Google Cloud Storage         ← データベースバックアップ・画像保存
```

## 前提条件

### 必要なツール

- Google Cloud CLI (`gcloud`)
- Docker
- Git
- Node.js 18 以上
- pnpm

### Google Cloud プロジェクト設定

```bash
# Google Cloud プロジェクトを作成・設定
gcloud projects create ai-agent-trpg-project
gcloud config set project ai-agent-trpg-project

# 必要なAPIを有効化
gcloud services enable cloudbuild.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable containerregistry.googleapis.com
```

## デプロイ準備

### 1. 環境変数の設定

プロジェクトルートに `.env.production` ファイルを作成：

```bash
# Google Cloud設定
PROJECT_ID=your-project-id
REGION=us-central1

# データベースバックアップ設定
LITESTREAM_GCS_BUCKET=trpg-database-backup
LITESTREAM_GCS_PATH=db

# AI API設定 (バックエンドの環境変数として設定)
OPENAI_API_KEY=your-openai-key
ANTHROPIC_API_KEY=your-anthropic-key
GOOGLE_CLOUD_PROJECT=your-project-id

# フロントエンド環境変数
REACT_APP_API_URL=https://trpg-backend-XXXXXXXXXX-uc.a.run.app
REACT_APP_SOCKET_URL=https://trpg-backend-XXXXXXXXXX-uc.a.run.app
```

### 2. Google Cloud Storage バケット作成

```bash
# データベースバックアップ用バケット
gsutil mb gs://trpg-database-backup

# 画像保存用バケット
gsutil mb gs://trpg-images-storage
```

### 3. サービスアカウント設定

```bash
# バックエンド用サービスアカウント作成
gcloud iam service-accounts create trpg-backend \
    --display-name="TRPG Backend Service Account"

# Cloud Storage権限付与
gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="serviceAccount:trpg-backend@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/storage.admin"

# Vertex AI権限付与（画像生成用）
gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="serviceAccount:trpg-backend@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/aiplatform.user"
```

## デプロイ手順

### 方法 1: Cloud Build を使用した自動デプロイ

#### 1. Cloud Build トリガー設定

```bash
# フロントエンド用トリガー作成
gcloud builds triggers create github \
    --repo-name=ai-agent-trpg-project \
    --repo-owner=YOUR_GITHUB_USERNAME \
    --branch-pattern="^main$" \
    --build-config=apps/frontend/cloudbuild.yaml \
    --name=trpg-frontend-deploy

# バックエンド用トリガー作成
gcloud builds triggers create github \
    --repo-name=AIAgentTRPGGM \
    --repo-owner=YOUR_GITHUB_USERNAME \
    --branch-pattern="^main$" \
    --build-config=apps/proxy-server/cloudbuild.yaml \
    --name=trpg-backend-deploy
```

#### 2. 手動ビルド実行

```bash
# フロントエンドをビルド・デプロイ
gcloud builds submit . --config=apps/frontend/cloudbuild.yaml \
    --substitutions=_REGION=us-central1

# バックエンドをビルド・デプロイ
gcloud builds submit . --config=apps/proxy-server/cloudbuild.yaml \
    --substitutions=_REGION=us-central1,_LITESTREAM_BUCKET=trpg-database-backup,_LITESTREAM_PATH=db,_SERVICE_ACCOUNT=trpg-backend@YOUR_PROJECT_ID.iam.gserviceaccount.com
```

### 方法 2: ローカルビルド・手動デプロイ

#### 1. フロントエンドのデプロイ

```bash
# Dockerイメージをビルド
docker build -f apps/frontend/Dockerfile -t gcr.io/YOUR_PROJECT_ID/trpg-frontend .

# Container Registryにpush
docker push gcr.io/YOUR_PROJECT_ID/trpg-frontend

# Cloud Runにデプロイ
gcloud run deploy trpg-frontend \
    --image gcr.io/YOUR_PROJECT_ID/trpg-frontend \
    --region us-central1 \
    --platform managed \
    --allow-unauthenticated \
    --port 8080 \
    --memory 512Mi \
    --cpu 1 \
    --max-instances 10 \
    --set-env-vars "REACT_APP_API_URL=https://trpg-backend-XXXXXXXXXX-uc.a.run.app"
```

#### 2. バックエンドのデプロイ

```bash
# Dockerイメージをビルド
docker build -f apps/proxy-server/Dockerfile -t gcr.io/YOUR_PROJECT_ID/trpg-backend .

# Container Registryにpush
docker push gcr.io/YOUR_PROJECT_ID/trpg-backend

# Cloud Runにデプロイ
gcloud run deploy trpg-backend \
    --image gcr.io/YOUR_PROJECT_ID/trpg-backend \
    --region us-central1 \
    --platform managed \
    --allow-unauthenticated \
    --port 8080 \
    --memory 2Gi \
    --cpu 2 \
    --max-instances 20 \
    --service-account trpg-backend@YOUR_PROJECT_ID.iam.gserviceaccount.com \
    --set-env-vars "NODE_ENV=production,LITESTREAM_GCS_BUCKET=trpg-database-backup,LITESTREAM_GCS_PATH=db,OPENAI_API_KEY=your-key,ANTHROPIC_API_KEY=your-key"
```

## デプロイ設定詳細

### フロントエンド設定 (trpg-frontend)

| 設定項目         | 値     | 説明                   |
| ---------------- | ------ | ---------------------- |
| メモリ           | 512Mi  | React SPA の配信に十分 |
| CPU              | 1      | 静的ファイル配信用     |
| 最大インスタンス | 10     | 同時接続数対応         |
| 同時実行数       | 80     | Nginx の処理能力       |
| タイムアウト     | 300 秒 | 標準的な値             |

### バックエンド設定 (trpg-backend)

| 設定項目         | 値     | 説明                            |
| ---------------- | ------ | ------------------------------- |
| メモリ           | 2Gi    | AI API 処理・データベース処理用 |
| CPU              | 2      | 複数 AI API 並列処理対応        |
| 最大インスタンス | 20     | 負荷分散対応                    |
| 同時実行数       | 50     | Node.js の適切な値              |
| タイムアウト     | 900 秒 | AI API 応答待ち時間考慮         |

### 環境変数設定

#### バックエンド必須環境変数

```bash
NODE_ENV=production
PORT=8080
LITESTREAM_GCS_BUCKET=trpg-database-backup
LITESTREAM_GCS_PATH=db
OPENAI_API_KEY=your-openai-api-key
ANTHROPIC_API_KEY=your-anthropic-api-key
GOOGLE_CLOUD_PROJECT=your-project-id
```

#### フロントエンド環境変数

```bash
REACT_APP_API_URL=https://trpg-backend-XXXXXXXXXX-uc.a.run.app
REACT_APP_SOCKET_URL=https://trpg-backend-XXXXXXXXXX-uc.a.run.app
```

## データベース・バックアップ設定

### Litestream 自動バックアップ

バックエンドには Litestream が統合されており、SQLite データベースを Google Cloud Storage に自動バックアップします。

#### Litestream 設定詳細

- **同期間隔**: 1 秒 (リアルタイム同期)
- **スナップショット間隔**: 1 時間
- **保持期間**: 72 時間
- **検証間隔**: 6 時間

#### バックアップの確認

```bash
# Cloud Storageでバックアップを確認
gsutil ls gs://trpg-database-backup/db/

# 特定の時点からのリストア
litestream restore -o /app/data/trpg.db gs://trpg-database-backup/db
```

## 本番運用

### 監視・ロギング

```bash
# Cloud Runサービスのログ確認
gcloud logs read "resource.type=cloud_run_revision" --limit=50

# フロントエンドログ
gcloud logs read "resource.type=cloud_run_revision AND resource.labels.service_name=trpg-frontend"

# バックエンドログ
gcloud logs read "resource.type=cloud_run_revision AND resource.labels.service_name=trpg-backend"
```

### スケーリング設定

```bash
# オートスケーリング設定の更新
gcloud run services update trpg-backend \
    --min-instances=1 \
    --max-instances=50 \
    --region=us-central1
```

### セキュリティ設定

```bash
# Identity and Access Management (IAM) 設定
gcloud run services add-iam-policy-binding trpg-backend \
    --member="allUsers" \
    --role="roles/run.invoker" \
    --region=us-central1
```

## 費用最適化

### 推定費用（月額）

- **Cloud Run（フロントエンド）**: $5-15
- **Cloud Run（バックエンド）**: $20-50
- **Cloud Storage**: $2-10
- **Container Registry**: $1-5
- **AI API 費用**: 利用量による（OpenAI GPT-4: $30/1M tokens）

### 費用削減のヒント

1. **最小インスタンス数**: 開発環境では 0 に設定
2. **メモリ最適化**: 実際の使用量に基づいて調整
3. **AI API 呼び出し最適化**: キャッシュとバッチ処理の活用

## トラブルシューティング

### よくある問題と解決法

#### 1. ビルドエラー

```bash
# キャッシュクリア
docker system prune -a

# モノリポの依存関係確認
cd /path/to/AIAgentTRPGGM
pnpm install
```

#### 2. デプロイタイムアウト

```bash
# タイムアウト時間延長
gcloud builds submit --timeout=3600s
```

#### 3. メモリ不足エラー

```bash
# メモリ増量
gcloud run services update trpg-backend \
    --memory=4Gi \
    --region=us-central1
```

#### 4. 環境変数が反映されない

```bash
# 環境変数確認
gcloud run services describe trpg-backend \
    --region=us-central1 \
    --format="value(spec.template.spec.template.spec.containers[0].env[].name,spec.template.spec.template.spec.containers[0].env[].value)"
```

### ログ確認コマンド

```bash
# リアルタイムログ監視
gcloud logs tail "resource.type=cloud_run_revision AND resource.labels.service_name=trpg-backend"

# エラーログのみフィルタ
gcloud logs read "resource.type=cloud_run_revision AND severity=ERROR" --limit=20
```

## CI/CD パイプライン

### GitHub Actions 連携（推奨）

`.github/workflows/deploy.yml` の例：

```yaml
name: Deploy to Cloud Run

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Build and Deploy Frontend
        run: |
          gcloud builds submit . --config=apps/frontend/cloudbuild.yaml

      - name: Build and Deploy Backend
        run: |
          gcloud builds submit . --config=apps/proxy-server/cloudbuild.yaml
```

## セキュリティベストプラクティス

### 1. API キー管理

- Secret Manager を使用して API キーを管理
- 環境変数での平文保存を避ける

```bash
# Secret Manager でAPI キー保存
gcloud secrets create openai-api-key --data-file=openai-key.txt
gcloud secrets create anthropic-api-key --data-file=anthropic-key.txt

# Cloud Run で Secret を環境変数として参照
gcloud run services update trpg-backend \
    --update-env-vars="OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai-api-key)"
```

### 2. IAM 最小権限の原則

```bash
# 必要最小限の権限のみ付与
gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="serviceAccount:trpg-backend@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/storage.objectAdmin"  # 読み書き可能だがバケット管理不可
```

## パフォーマンス最適化

### 1. フロントエンド最適化

- **Nginx gzip 圧縮**: 有効化済み
- **静的ファイルキャッシュ**: 1 年設定
- **CDN 活用**: Cloud CDN との連携推奨

### 2. バックエンド最適化

- **データベース接続プール**: 設定済み
- **AI API レスポンスキャッシュ**: Redis 導入推奨
- **画像最適化**: Sharp による自動リサイズ

## まとめ

このデプロイガイドに従って、TRPG AI エージェント GM を Google Cloud Run に正常にデプロイできます。本番運用では、モニタリング、セキュリティ、パフォーマンス最適化を継続的に行うことが重要です。

追加のサポートが必要な場合は、プロジェクトの GitHub Issues または担当者にお問い合わせください。
