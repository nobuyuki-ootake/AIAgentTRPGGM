# TRPGプロジェクト - ユーザー対応必要タスク一覧

## 🚀 1. Google Cloud Platform セットアップ（初回のみ）

### 1.1 Google Cloud アカウント・プロジェクト作成
```bash
# 1. Google Cloud Console にアクセス
https://console.cloud.google.com/

# 2. 新しいプロジェクトを作成
プロジェクト名: trpg-gm-assistant
プロジェクトID: trpg-gm-assistant-[ランダム文字列]
```

### 1.2 必要なAPIの有効化
```bash
# Google Cloud Console で以下のAPIを有効化:
- Cloud Run API
- Cloud Build API
- Cloud Storage API
- Vertex AI API
- Container Registry API
- IAM Service Account Credentials API
```

### 1.3 課金設定
```bash
# 1. 課金アカウントをプロジェクトにリンク
# 2. 予算アラートの設定（推奨: $50/月）
# 3. Cloud Storage料金確認（~$0.02/GB/月）
# 4. Vertex AI料金確認（Imagen: $0.03/画像）
```

### 1.4 サービスアカウント作成
```bash
# 1. IAM & Admin > サービスアカウント
# 2. 新しいサービスアカウント作成
名前: trpg-service-account
権限:
- Cloud Run Admin
- Cloud Storage Admin  
- Vertex AI User
- Storage Object Admin
- Cloud Build Service Account

# 3. JSONキーファイルをダウンロード
# ファイル名: trpg-service-account-key.json
```

## 🗄️ 2. Cloud Storage バケット作成

### 2.1 ストレージバケット設定
```bash
# Google Cloud Console > Cloud Storage
バケット名: trpg-gm-assistant-storage-[プロジェクトID]
リージョン: us-central1（推奨）
ストレージクラス: Standard
アクセス制御: 詳細（オブジェクトレベル）
公開アクセス: 有効（画像表示用）
```

### 2.2 バケット構造
```
trpg-gm-assistant-storage/
├── uploads/
│   └── [user-id]/
│       ├── characters/
│       ├── maps/
│       └── handouts/
├── generated/
│   ├── images/
│   └── ai-content/
└── backups/
    └── database/
        ├── snapshots/         # Litestream スナップショット
        ├── wal/              # Write-Ahead Log ファイル
        └── replicas/         # 複製データベース
```

## 💾 3. Litestream データベースバックアップ設定

### 3.1 Litestream とは
```bash
# Litestream は SQLite データベースのリアルタイムバックアップツール
特徴:
- リアルタイム複製（Write-Ahead Log ベース）
- Cloud Storage への自動バックアップ
- ポイントインタイム復旧
- ゼロダウンタイム復旧
- 月額コスト: ~$1-3（数GB程度）
```

### 3.2 Litestream設定ファイル確認
```yaml
# apps/proxy-server/litestream.yml（既に作成済み）
dbs:
  - path: /app/data/trpg.db
    replicas:
      - type: gcs
        bucket: trpg-gm-assistant-storage-[PROJECT-ID]
        path: backups/database
        retention: 72h
        snapshot-interval: 1h
        sync-interval: 1s
```

### 3.3 Litestream 権限設定
```bash
# サービスアカウントに以下の権限が必要（既に設定済み）:
- Storage Object Admin（ファイル読み書き）
- Storage Legacy Bucket Reader（バケット情報読み取り）

# 環境変数での認証設定:
GOOGLE_APPLICATION_CREDENTIALS=/app/service-account-key.json
```

### 3.4 Litestream 動作確認方法
```bash
# 1. ローカルでの動作確認
cd apps/proxy-server
npm run dev

# ログで以下を確認:
# "Litestream replica started"
# "Database backup initialized"

# 2. Cloud Storage での確認
# Google Cloud Console > Cloud Storage > バケット
# backups/database/ フォルダに以下が作成されることを確認:
- snapshots/xxx.db.gz（定期スナップショット）
- wal/xxx.db-wal（リアルタイム変更ログ）
```

### 3.5 データベース復旧手順
```bash
# 災害復旧時の手順:

# 1. 新しいインスタンスでの復旧
docker run --rm \
  -e GOOGLE_APPLICATION_CREDENTIALS=/app/service-account-key.json \
  -v /path/to/service-account-key.json:/app/service-account-key.json \
  litestream/litestream:latest \
  restore -o /tmp/restored.db gcs://your-bucket/backups/database

# 2. 特定時点への復旧
litestream restore -o /tmp/restored.db \
  -timestamp 2024-01-15T10:30:00Z \
  gcs://your-bucket/backups/database

# 3. Cloud Run での自動復旧
# コンテナ起動時に自動実行（Dockerfile で設定済み）
```

### 3.6 Litestream モニタリング
```bash
# 1. バックアップ状態確認
litestream snapshots gcs://your-bucket/backups/database

# 2. 複製遅延確認  
litestream replicate -dry-run gcs://your-bucket/backups/database

# 3. Cloud Monitoring アラート設定（推奨）
- バックアップ失敗検知
- 複製遅延検知（1分以上）
- ストレージ使用量監視
```

### 3.7 Litestream パフォーマンス設定
```yaml
# 高負荷時の設定調整（litestream.yml）
dbs:
  - path: /app/data/trpg.db
    replicas:
      - type: gcs
        bucket: trpg-gm-assistant-storage-[PROJECT-ID]
        path: backups/database
        retention: 168h              # 7日間保持（増加）
        snapshot-interval: 30m       # スナップショット間隔（短縮）
        sync-interval: 500ms         # 同期間隔（短縮）
        validation-interval: 6h      # 整合性チェック
```

## ⚙️ 4. 環境変数・シークレット設定

### 4.1 必要な環境変数一覧
```bash
# Google Cloud 関連
GOOGLE_CLOUD_PROJECT_ID=trpg-gm-assistant-xxx
GOOGLE_CLOUD_LOCATION=us-central1
GOOGLE_CLOUD_STORAGE_BUCKET=trpg-gm-assistant-storage-xxx

# 認証関連
JWT_SECRET=your-super-secret-jwt-key-here
JWT_REFRESH_SECRET=your-super-secret-refresh-key-here
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# API キー（オプション - 従来のAI API用）
OPENAI_API_KEY=sk-xxx（オプション）
ANTHROPIC_API_KEY=sk-ant-xxx（オプション）
GEMINI_API_KEY=AIzaxxx（オプション）

# アプリケーション設定
NODE_ENV=production
PORT=8080
FRONTEND_URL=https://trpg-frontend-xxx.a.run.app
API_KEY=your-api-key-for-legacy-endpoints
DEVELOPER_MODE=false
```

### 4.2 サービスアカウントキー設定
```bash
# Cloud Run で環境変数として設定:
GOOGLE_APPLICATION_CREDENTIALS=/app/service-account-key.json

# または、Dockerfileで組み込み:
COPY service-account-key.json /app/service-account-key.json
```

## 🏗️ 5. Cloud Build・CI/CD セットアップ

### 5.1 GitHub連携設定
```bash
# 1. Cloud Build > トリガー
# 2. リポジトリを接続
GitHub リポジトリ: your-username/NovelWithAgent
ブランチ: main または develop2

# 3. 2つのトリガーを作成:
```

### 5.2 フロントエンド用トリガー
```yaml
# トリガー名: trpg-frontend-deploy
# トリガータイプ: プッシュ（ブランチ）
# ブランチ: ^main$
# 対象パス: apps/frontend/**
# ビルド設定: apps/frontend/cloudbuild.yaml
```

### 5.3 バックエンド用トリガー
```yaml
# トリガー名: trpg-backend-deploy  
# トリガータイプ: プッシュ（ブランチ）
# ブランチ: ^main$
# 対象パス: apps/proxy-server/**
# ビルド設定: apps/proxy-server/cloudbuild.yaml
```

### 5.4 置換変数設定
```bash
# 各トリガーで設定:
_PROJECT_ID: trpg-gm-assistant-xxx
_REGION: us-central1
_SERVICE_NAME_FRONTEND: trpg-frontend
_SERVICE_NAME_BACKEND: trpg-backend
```

## 🚢 6. Cloud Run サービス作成

### 6.1 バックエンドサービス設定
```bash
# サービス名: trpg-backend
# リージョン: us-central1
# 認証: 認証が必要（後で変更）
# CPU: 1vCPU
# メモリ: 2GiB
# 最大インスタンス数: 10
# 最小インスタンス数: 0
# 同時実行数: 80
```

### 6.2 フロントエンドサービス設定
```bash
# サービス名: trpg-frontend
# リージョン: us-central1
# 認証: 認証を必要としない（一般公開）
# CPU: 1vCPU
# メモリ: 1GiB
# 最大インスタンス数: 5
# 最小インスタンス数: 0
```

### 6.3 環境変数設定（Cloud Run）
```bash
# trpg-backend サービスの環境変数:
GOOGLE_CLOUD_PROJECT_ID=your-project-id
GOOGLE_CLOUD_STORAGE_BUCKET=your-bucket-name
JWT_SECRET=your-jwt-secret
NODE_ENV=production
PORT=8080

# trpg-frontend サービスの環境変数:
VITE_API_URL=https://trpg-backend-xxx.a.run.app
VITE_SOCKET_URL=https://trpg-backend-xxx.a.run.app
NODE_ENV=production
```

## 🔐 7. IAM・セキュリティ設定

### 7.1 Cloud Run サービス間通信
```bash
# trpg-backend サービスのIAM設定:
# 1. Cloud Run > trpg-backend > セキュリティ
# 2. 新しいプリンシパルを追加:
プリンシパル: allUsers
ロール: Cloud Run 起動元

# フロントエンドからのアクセス許可
```

### 7.2 CORS設定確認
```javascript
// apps/proxy-server/src/index.ts で設定済み
cors({
  origin: process.env.FRONTEND_URL, // Cloud Run frontend URL
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
})
```

## 📋 8. 初回デプロイ手順

### 8.1 手動デプロイ（初回のみ）
```bash
# 1. Google Cloud SDK インストール
curl https://sdk.cloud.google.com | bash
exec -l $SHELL
gcloud init

# 2. プロジェクト設定
gcloud config set project trpg-gm-assistant-xxx

# 3. 認証情報を配置
# service-account-key.json を apps/proxy-server/ に配置

# 4. 手動ビルド・デプロイ（バックエンド）
cd apps/proxy-server
gcloud builds submit --config cloudbuild.yaml

# 5. 手動ビルド・デプロイ（フロントエンド）
cd apps/frontend  
gcloud builds submit --config cloudbuild.yaml
```

### 8.2 サービスURL確認
```bash
# デプロイ後のURL:
フロントエンド: https://trpg-frontend-xxx.a.run.app
バックエンド: https://trpg-backend-xxx.a.run.app

# ヘルスチェック:
curl https://trpg-backend-xxx.a.run.app/health
```

## 🔧 9. 開発・運用設定

### 9.1 ローカル開発設定
```bash
# 1. サービスアカウントキー配置
cp service-account-key.json apps/proxy-server/

# 2. 環境変数設定
# apps/proxy-server/.env
GOOGLE_CLOUD_PROJECT_ID=trpg-gm-assistant-xxx
GOOGLE_CLOUD_STORAGE_BUCKET=trpg-gm-assistant-storage-xxx
GOOGLE_APPLICATION_CREDENTIALS=./service-account-key.json
JWT_SECRET=dev-secret-key

# 3. ローカル実行
cd apps/proxy-server
npm run dev
```

### 9.2 モニタリング設定
```bash
# Cloud Console でモニタリング設定:
# 1. Monitoring > アラート ポリシー
# 2. 以下のアラートを作成:
- Cloud Run CPU使用率 > 80%  
- Cloud Run メモリ使用率 > 80%
- Cloud Run エラー率 > 5%
- Cloud Storage 使用量 > 10GB
```

## 📊 10. 継続的なタスク

### 10.1 日常的な確認項目
```bash
# 毎週確認:
- [ ] Cloud Run ログ確認（エラーの有無）
- [ ] Cloud Storage 使用量確認
- [ ] 課金額確認（月次予算内かチェック）

# 毎月確認:  
- [ ] セキュリティアップデート
- [ ] バックアップ確認（Litestream）
- [ ] パフォーマンス最適化
```

### 10.2 スケーリング設定調整
```bash
# トラフィック増加時:
# 1. Cloud Run > サービス > 編集
# 2. 最大インスタンス数を調整
# 3. CPU・メモリ設定を調整
# 4. 同時実行数を調整
```

## ⚠️ 11. トラブルシューティング

### 11.1 よくある問題と解決法
```bash
# デプロイエラー:
- ビルドタイムアウト → cloudbuild.yaml のタイムアウト設定を増加
- 権限エラー → サービスアカウントの権限確認
- イメージサイズエラー → .dockerignore の確認

# ランタイムエラー:
- 環境変数未設定 → Cloud Run の環境変数確認
- DB接続エラー → Litestream設定確認
- 画像生成エラー → Vertex AI API有効化確認
```

### 11.2 ログ確認方法
```bash
# Cloud Run ログ:
Cloud Console > Cloud Run > サービス > ログ

# Cloud Build ログ:  
Cloud Console > Cloud Build > 履歴

# Cloud Storage ログ:
Cloud Console > Cloud Storage > 監査ログ
```

---

### 11.3 Litestream 関連トラブルシューティング
```bash
# Litestream バックアップ失敗:
- [ ] Cloud Storage バケットの権限確認
- [ ] サービスアカウントキーの有効性確認  
- [ ] litestream.yml の設定確認
- [ ] ディスク容量確認

# データベース復旧失敗:
- [ ] バックアップファイルの存在確認
- [ ] 権限設定の確認
- [ ] タイムスタンプ形式の確認

# 複製遅延問題:
- [ ] ネットワーク接続確認
- [ ] Cloud Storage レスポンス時間確認
- [ ] sync-interval 設定の調整

# パフォーマンス問題:
- [ ] snapshot-interval の調整（負荷軽減）
- [ ] retention 設定の最適化
- [ ] データベースサイズの確認
```

---

## 📝 実装優先度

### Phase 1（必須・即座に対応）
- [ ] Google Cloud アカウント・プロジェクト作成
- [ ] 必要なAPI有効化
- [ ] サービスアカウント作成
- [ ] Cloud Storage バケット作成

### Phase 2（デプロイ準備）
- [ ] Cloud Storage バケット作成
- [ ] Litestream 設定確認・テスト
- [ ] 環境変数設定
- [ ] Cloud Build トリガー設定
- [ ] Cloud Run サービス作成
- [ ] 初回手動デプロイ

### Phase 3（運用開始）
- [ ] CICD自動化確認
- [ ] Litestream バックアップ動作確認
- [ ] モニタリング設定（Litestream含む）
- [ ] セキュリティ確認
- [ ] パフォーマンステスト
- [ ] 災害復旧テスト

このガイドに従って設定していただければ、TRPGアプリケーションがCloud Runで稼働開始できます。不明な点があればお気軽にお聞きください！

## 📞 サポート情報

### Google Cloud サポート
- [Google Cloud Console](https://console.cloud.google.com/)
- [Cloud Run ドキュメント](https://cloud.google.com/run/docs)
- [Cloud Build ドキュメント](https://cloud.google.com/build/docs)
- [Vertex AI ドキュメント](https://cloud.google.com/vertex-ai/docs)

### プロジェクト固有の設定
- **リポジトリ**: `NovelWithAgent`
- **メインブランチ**: `develop2` または `main`
- **フロントエンドパス**: `apps/frontend/`
- **バックエンドパス**: `apps/proxy-server/`
- **型定義パス**: `packages/types/`

### 料金目安（月額）
- **Cloud Run**: $5-20（トラフィック次第）
- **Cloud Storage**: $1-5（画像数次第）
- **Litestream バックアップ**: $1-3（データベースサイズ次第）
- **Vertex AI**: $3-30（画像生成数次第）
- **合計予想**: $10-58/月

### Litestream 具体的なコスト
- **ストレージ**: ~$0.02/GB/月（標準クラス）
- **操作料金**: 読み書き操作で若干の追加料金
- **データ転送**: 同一リージョン内は無料
- **例**: 1GBデータベース → 月額 ~$0.50-1.00