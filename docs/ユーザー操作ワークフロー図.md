# ユーザー操作ワークフロー図

## 概要

TRPG AI エージェント GM システムにおけるユーザー操作の標準的なワークフローを図解し、E2E テスト設計とユーザビリティ向上のための参考資料として提供します。

## 📋 目次

1. [一般ユーザー: セッション開始からクリアまでのフロー](#1-一般ユーザー-セッション開始からクリアまでのフロー)
2. [一般ユーザー: シナリオ作成・保存フロー](#2-一般ユーザー-シナリオ作成保存フロー)
3. [開発者ユーザー: キャラクター管理フロー](#3-開発者ユーザー-キャラクター管理フロー)
4. [開発者ユーザー: タイムライン・イベント管理フロー](#4-開発者ユーザー-タイムラインイベント管理フロー)
5. [エラー状態・例外処理フロー](#5-エラー状態例外処理フロー)
6. [AI応答待機・非同期処理フロー](#6-ai応答待機非同期処理フロー)
7. [モード切り替え時のUI動的変更フロー](#7-モード切り替え時のui動的変更フロー)

---

## 1. 一般ユーザー: セッション開始からクリアまでのフロー

```mermaid
flowchart TD
    A[ホーム画面アクセス] --> B{キャンペーン選択}
    
    B -->|既存キャンペーン| C[キャンペーン詳細表示]
    B -->|新規作成| D[新規キャンペーン作成]
    
    D --> D1[基本情報入力]
    D1 --> D2[ゲームシステム選択]
    D2 --> D3[ジャンル・設定選択]
    D3 --> D4[AI世界観生成提案受諾]
    D4 --> C
    
    C --> E[プレイヤーキャラクター選択]
    E --> F{開発者モード?}
    
    F -->|OFF| G[一般ユーザーモード]
    F -->|ON| H[開発者ユーザーモード]
    
    G --> I[「AIにセッションマスターをしてもらう」選択]
    I --> J{プレイモード選択}
    
    J -->|シングルプレイ| K[ソロセッション開始]
    J -->|マルチプレイ| L[マルチプレイセッション作成/参加]
    
    K --> M[セッション画面]
    L --> M
    
    M --> N[AI GM による導入]
    N --> O[タイムライン自動進行開始]
    
    O --> P{イベント発生チェック}
    
    P -->|通常イベント| Q[ストーリーイベント]
    P -->|敵遭遇| R[戦闘イベント]
    P -->|トラップ| S[判定イベント]
    P -->|NPC遭遇| T[会話イベント]
    
    Q --> U[選択肢表示・プレイヤー選択]
    R --> V[AI制御ダイス要求]
    S --> V
    T --> W[NPC AI会話システム]
    
    U --> X[AI GM応答・結果処理]
    V --> Y[ダイス結果処理・戦闘解決]
    W --> X
    Y --> X
    
    X --> Z[タイムライン状態更新]
    Z --> AA{セッション継続判定}
    
    AA -->|継続| O
    AA -->|クリア条件達成| BB[セッション成功]
    AA -->|失敗条件到達| CC[セッション失敗]
    AA -->|プレイヤー中断| DD[セッション保存・中断]
    
    BB --> EE[結果画面・報酬表示]
    CC --> EE
    DD --> FF[進捗保存・ホーム復帰]
    
    EE --> GG[キャンペーン完了・ホーム復帰]
    
    style A fill:#e1f5fe
    style GG fill:#c8e6c9
    style BB fill:#81c784
    style CC fill:#ffab91
    style M fill:#fff3e0
    style V fill:#f8bbd9
```

## 2. 一般ユーザー: シナリオ作成・保存フロー

```mermaid
flowchart TD
    A[ホーム画面] --> B[キャンペーン選択]
    B --> C[キャンペーン管理画面]
    
    C --> D{作業選択}
    D -->|新規シナリオ| E[シナリオ作成開始]
    D -->|既存編集| F[シナリオ一覧]
    
    E --> G[タイムラインページ]
    F --> H[シナリオ選択]
    H --> G
    
    G --> I[イベント管理画面]
    I --> J{イベント操作}
    
    J -->|新規追加| K[イベント作成ダイアログ]
    J -->|編集| L[イベント編集ダイアログ]
    J -->|削除| M[削除確認]
    
    K --> N[イベント詳細入力]
    L --> N
    
    N --> O[イベント種類選択]
    O --> P{イベントタイプ}
    
    P -->|戦闘| Q[エネミー配置]
    P -->|会話| R[NPC・台詞設定]
    P -->|探索| S[調査対象設定]
    P -->|トラップ| T[トラップ設定]
    
    Q --> U[発生条件設定]
    R --> U
    S --> U
    T --> U
    
    U --> V[場所・時間設定]
    V --> W[確率・優先度設定]
    W --> X[プレビュー確認]
    
    X --> Y{保存確認}
    Y -->|保存| Z[イベント保存]
    Y -->|キャンセル| I
    
    Z --> AA{作業継続}
    AA -->|続ける| I
    AA -->|完了| AB[シナリオ保存]
    
    AB --> AC[保存オプション]
    AC --> AD{保存方法}
    
    AD -->|自動保存| AE[バックグラウンド保存]
    AD -->|手動保存| AF[保存ダイアログ]
    
    AE --> AG[保存完了通知]
    AF --> AH[名前・説明入力]
    AH --> AG
    
    AG --> AI[シナリオ一覧更新]
    AI --> C
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style Z fill:#c8e6c9
    style AB fill:#c8e6c9
    style Q fill:#ffcdd2
    style R fill:#f3e5f5
    style S fill:#e8f5e9
    style T fill:#ffe0b2
```

## 3. 開発者ユーザー: キャラクター管理フロー

```mermaid
flowchart TD
    A[ホーム画面] --> B[開発者モード有効化]
    B --> C[キャンペーン選択]
    C --> D[キャンペーン管理画面]
    
    D --> E{管理対象選択}
    E -->|PC管理| F[PCキャラクター一覧]
    E -->|NPC管理| G[NPCキャラクター一覧]
    E -->|エネミー管理| H[エネミー一覧]
    
    F --> I{操作選択}
    G --> I
    H --> I
    
    I -->|新規作成| J[キャラクター作成フォーム]
    I -->|編集| K[既存キャラクター選択]
    I -->|削除| L[削除確認ダイアログ]
    I -->|インポート| M[インポートダイアログ]
    
    K --> J
    
    J --> N[基本情報入力]
    N --> O[名前・外見設定]
    O --> P[種族・クラス選択]
    P --> Q[背景・性格設定]
    
    Q --> R{AI支援使用}
    R -->|使用する| S[AI生成オプション]
    R -->|使用しない| T[手動入力継続]
    
    S --> U[AI提案確認]
    U --> V{提案採用}
    V -->|採用| W[能力値設定]
    V -->|修正| T
    
    T --> W
    
    W --> X[基本能力値配分]
    X --> Y[派生ステータス計算]
    Y --> Z[スキル・特技選択]
    
    Z --> AA{キャラクタータイプ別設定}
    AA -->|PC| AB[初期装備選択]
    AA -->|NPC| AC[役割・スケジュール設定]
    AA -->|エネミー| AD[戦闘AI設定]
    
    AB --> AE[画像アップロード]
    AC --> AE
    AD --> AE
    
    AE --> AF{画像選択}
    AF -->|アップロード| AG[ファイル選択]
    AF -->|AI生成| AH[画像生成プロンプト]
    AF -->|スキップ| AI[デフォルト画像]
    
    AG --> AJ[画像プレビュー]
    AH --> AK[AI画像生成]
    AK --> AJ
    AI --> AJ
    
    AJ --> AL[最終確認画面]
    AL --> AM{保存確認}
    
    AM -->|保存| AN[データベース保存]
    AM -->|修正| N
    
    AN --> AO[保存完了通知]
    AO --> AP[一覧画面更新]
    
    AP --> I
    
    M --> AQ[インポート形式選択]
    AQ --> AR{形式選択}
    
    AR -->|ユドナリウム| AS[XML解析]
    AR -->|Foundry VTT| AT[JSON解析]
    AR -->|Roll20| AU[API連携]
    AR -->|汎用JSON| AV[JSONマッピング]
    
    AS --> AW[データ変換]
    AT --> AW
    AU --> AW
    AV --> AW
    
    AW --> AX[プレビュー表示]
    AX --> AY[インポート実行]
    AY --> AN
    
    style A fill:#e1f5fe
    style B fill:#fff9c4
    style J fill:#fff3e0
    style AN fill:#c8e6c9
    style S fill:#e8eaf6
    style AK fill:#e8eaf6
```

## 4. 開発者ユーザー: タイムライン・イベント管理フロー

```mermaid
flowchart TD
    A[開発者モード有効] --> B[タイムラインページ]
    B --> C[タイムライン表示]
    
    C --> D{表示モード}
    D -->|日付ビュー| E[カレンダー形式]
    D -->|リストビュー| F[イベント一覧]
    D -->|マップビュー| G[地図連動表示]
    
    E --> H[イベント管理UI]
    F --> H
    G --> H
    
    H --> I{操作選択}
    I -->|新規イベント| J[イベント作成ウィザード]
    I -->|編集| K[イベント選択]
    I -->|複製| L[イベントコピー]
    I -->|削除| M[削除確認]
    
    K --> N[イベント編集画面]
    L --> N
    
    J --> O[Step 1: 基本情報]
    O --> P[イベント名・説明]
    P --> Q[イベントカテゴリ選択]
    
    Q --> R{カテゴリ}
    R -->|メインクエスト| S[重要度: 高設定]
    R -->|サブクエスト| T[重要度: 中設定]
    R -->|ランダム遭遇| U[重要度: 低設定]
    R -->|環境イベント| V[環境条件設定]
    
    S --> W[Step 2: 発生条件]
    T --> W
    U --> W
    V --> W
    
    W --> X[時間条件設定]
    X --> Y[場所条件設定]
    Y --> Z[前提条件設定]
    
    Z --> AA{条件タイプ}
    AA -->|キャラクター| AB[必要キャラクター選択]
    AA -->|アイテム| AC[必要アイテム設定]
    AA -->|クエスト進行| AD[前提クエスト選択]
    AA -->|ステータス| AE[ステータス条件]
    
    AB --> AF[Step 3: イベント内容]
    AC --> AF
    AD --> AF
    AE --> AF
    
    AF --> AG{内容タイプ}
    AG -->|戦闘| AH[戦闘設定画面]
    AG -->|会話| AI[会話スクリプト]
    AG -->|判定| AJ[スキル判定設定]
    AG -->|報酬| AK[報酬設定]
    
    AH --> AL[エネミー配置]
    AL --> AM[戦闘勝利条件]
    AM --> AN[戦闘報酬設定]
    
    AI --> AO[NPC選択]
    AO --> AP[会話分岐設定]
    AP --> AQ[選択肢結果設定]
    
    AJ --> AR[判定種類選択]
    AR --> AS[難易度設定]
    AS --> AT[成功/失敗結果]
    
    AK --> AU[報酬タイプ選択]
    AU --> AV[報酬内容設定]
    
    AN --> AW[Step 4: 後続処理]
    AQ --> AW
    AT --> AW
    AV --> AW
    
    AW --> AX[結果による分岐]
    AX --> AY[世界状態変更]
    AY --> AZ[後続イベント設定]
    
    AZ --> BA[Step 5: テスト実行]
    BA --> BB[シミュレーション開始]
    BB --> BC[結果確認]
    
    BC --> BD{テスト結果}
    BD -->|成功| BE[保存確認]
    BD -->|要修正| O
    
    BE --> BF[イベント保存]
    BF --> BG[タイムライン更新]
    BG --> C
    
    N --> O
    
    style A fill:#fff9c4
    style B fill:#e1f5fe
    style J fill:#fff3e0
    style BF fill:#c8e6c9
    style AH fill:#ffcdd2
    style AI fill:#f3e5f5
    style AJ fill:#e8f5e9
    style BB fill:#e8eaf6
```

## 🔄 モード切り替えによる UI 変化

```mermaid
flowchart LR
    A[一般ユーザーモード] --> B{UI要素表示}
    B --> C[シンプルUI]
    C --> D[基本機能のみ]
    D --> E[- セッション開始<br/>- キャラクター選択<br/>- 保存/読込]
    
    F[開発者モード] --> G{UI要素表示}
    G --> H[拡張UI]
    H --> I[全機能アクセス]
    I --> J[- イベント編集<br/>- AI設定調整<br/>- デバッグツール<br/>- 詳細ステータス]
    
    K[モード切替ボタン] --> L{権限チェック}
    L -->|一般→開発者| M[パスワード入力]
    L -->|開発者→一般| N[即座に切替]
    
    M --> O{認証}
    O -->|成功| F
    O -->|失敗| A
    N --> A
    
    style A fill:#e3f2fd
    style F fill:#fff9c4
    style C fill:#e8f5e9
    style H fill:#ffe0b2
```

## 📊 エラー処理・例外フロー

```mermaid
flowchart TD
    A[通常操作] --> B{エラー検出}
    B -->|ネットワークエラー| C[接続エラー処理]
    B -->|データエラー| D[検証エラー処理]
    B -->|AIエラー| E[AI応答エラー処理]
    B -->|システムエラー| F[致命的エラー処理]
    
    C --> G[再接続試行]
    G --> H{再接続成功?}
    H -->|成功| I[操作再開]
    H -->|失敗| J[オフラインモード]
    
    D --> K[エラー内容表示]
    K --> L[修正ガイド表示]
    L --> M[入力画面へ戻る]
    
    E --> N[代替処理実行]
    N --> O[ローカルAI使用]
    O --> P[簡易応答生成]
    
    F --> Q[エラーログ保存]
    Q --> R[緊急保存実行]
    R --> S[再起動案内]
    
    J --> T[ローカル保存]
    T --> U[復帰時同期]
    
    style B fill:#ffcdd2
    style I fill:#c8e6c9
    style J fill:#ffe0b2
    style N fill:#e8eaf6
    style R fill:#fff9c4
```

## 🎮 AI 応答待機・非同期処理フロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant UI as UI画面
    participant API as APIクライアント
    participant S as サーバー
    participant AI as AIエージェント
    participant DB as データベース
    
    U->>UI: アクション実行
    UI->>UI: ローディング表示開始
    UI->>API: リクエスト送信
    
    API->>S: HTTP Request
    S->>AI: AI処理要求
    
    Note over AI: AI処理中...<br/>(1-10秒)
    
    par AI応答生成
        AI->>AI: コンテキスト構築
        AI->>AI: プロンプト処理
        AI->>AI: 応答生成
    and タイムアウト監視
        S->>S: タイムアウトチェック
    and UI更新
        loop 500msごと
            UI->>UI: プログレス更新
            UI->>U: 処理中アニメーション
        end
    end
    
    alt 正常応答
        AI->>S: 応答返却
        S->>DB: 結果保存
        DB->>S: 保存完了
        S->>API: 成功レスポンス
        API->>UI: データ受信
        UI->>UI: ローディング終了
        UI->>U: 結果表示
    else タイムアウト
        S->>API: タイムアウトエラー
        API->>UI: エラー受信
        UI->>UI: ローディング終了
        UI->>U: エラー表示・リトライ案内
    else AIエラー
        AI->>S: エラー返却
        S->>API: エラーレスポンス
        API->>UI: エラー受信
        UI->>UI: フォールバック処理
        UI->>U: 代替応答表示
    end
```

---

## 5. エラー状態・例外処理フロー

```mermaid
flowchart TD
    A[ユーザー操作実行] --> B{エラー検出}
    
    B -->|通信エラー| C[ネットワークエラー処理]
    B -->|バリデーションエラー| D[入力検証エラー処理]
    B -->|AI応答エラー| E[AI サービスエラー処理]
    B -->|データ保存エラー| F[ストレージエラー処理]
    B -->|セッションエラー| G[セッション状態エラー処理]
    
    C --> C1[接続状態確認]
    C1 --> C2[自動再試行(3回)]
    C2 --> C3{再試行成功?}
    
    C3 -->|成功| H[正常処理継続]
    C3 -->|失敗| I[オフラインモード提案]
    
    D --> D1[エラー箇所ハイライト]
    D1 --> D2[具体的修正方法表示]
    D2 --> D3[関連ヘルプ表示]
    D3 --> J[ユーザー修正待ち]
    
    E --> E1[AI サービス状態確認]
    E1 --> E2[代替 AI プロバイダー試行]
    E2 --> E3{代替成功?}
    
    E3 -->|成功| H
    E3 -->|失敗| K[AI 機能一時無効化]
    
    F --> F1[ローカル保存試行]
    F1 --> F2[自動バックアップ確認]
    F2 --> F3[データ復旧オプション提示]
    
    G --> G1[セッション状態診断]
    G1 --> G2[状態復元試行]
    G2 --> G3{復元成功?}
    
    G3 -->|成功| H
    G3 -->|失敗| L[セッション再開オプション]
    
    I --> M[ローカル機能のみ利用]
    J --> N[入力修正後再実行]
    K --> O[マニュアル入力モード]
    F3 --> P[復旧処理実行]
    L --> Q[新規セッション開始 or データ復旧]
    
    M --> R[機能制限通知表示]
    N --> A
    O --> S[AI 無し進行]
    P --> T[保存処理再実行]
    Q --> U[ユーザー選択実行]
    
    R --> H
    S --> H
    T --> H
    U --> H
    
    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style C fill:#ffcdd2
    style D fill:#fff3e0
    style E fill:#f8bbd9
```

## 6. AI応答待機・非同期処理フロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant UI as フロントエンド
    participant API as プロキシサーバー
    participant AI as AI サービス
    participant DB as データベース

    Note over U,DB: AI 応答要求フロー

    U->>UI: アクション実行(メッセージ送信等)
    UI->>UI: ローディング状態表示
    UI->>API: AI 要求送信

    Note over API: コンテキスト構築
    API->>DB: 関連データ取得
    DB->>API: キャンペーン・キャラクターデータ
    API->>API: プロンプト生成・コンテキスト統合

    API->>AI: AI 応答要求
    
    Note over AI: AI 処理時間(1-30秒)
    
    alt AI 応答成功
        AI->>API: 応答データ
        API->>API: 応答データ解析・検証
        API->>DB: 結果保存
        API->>UI: 成功応答
        UI->>UI: ローディング解除
        UI->>U: AI 応答表示
        
    else AI 応答タイムアウト
        Note over AI: 30秒タイムアウト
        API->>UI: タイムアウトエラー
        UI->>UI: エラー状態表示
        UI->>U: 「AI 応答に時間がかかっています。再試行しますか？」
        
        U->>UI: 再試行選択
        UI->>API: 再試行要求
        
    else AI サービスエラー
        AI->>API: エラー応答
        API->>UI: エラー通知
        UI->>UI: エラー状態表示
        UI->>U: 「AI サービスが利用できません。手動で進行しますか？」
        
        U->>UI: 手動進行選択
        UI->>U: 手動入力フォーム表示
    end

    Note over U,DB: 非同期バックグラウンド処理

    par 自動保存処理
        UI->>API: 自動保存要求
        API->>DB: データ保存
        DB->>API: 保存完了
        API->>UI: 保存完了通知
        UI->>U: 保存状態表示(3秒間)
        
    and リアルタイム同期処理
        UI->>API: WebSocket 接続維持
        API->>UI: 他プレイヤー状態更新
        UI->>U: 状態変化表示
        
    and バックグラウンド AI 処理
        API->>AI: 事前計算要求(NPC 行動等)
        AI->>API: 事前計算結果
        API->>DB: 結果キャッシュ
    end
```

## 7. モード切り替え時のUI動的変更フロー

```mermaid
stateDiagram-v2
    [*] --> 一般モード: 初期状態
    
    一般モード --> 開発者モード: 開発者モード有効化
    開発者モード --> 一般モード: 開発者モード無効化
    
    state 一般モード {
        [*] --> ホーム画面表示
        ホーム画面表示 --> キャンペーン選択
        キャンペーン選択 --> セッション開始
        セッション開始 --> プレイ画面
        
        プレイ画面 --> AI_GM_モード: AI GM 選択
        AI_GM_モード --> シングルプレイ: ソロプレイ選択
        AI_GM_モード --> マルチプレイ: マルチプレイ選択
        
        state "制限された機能" as 制限機能 {
            キャラクター閲覧のみ
            タイムライン閲覧のみ
            設定変更不可
            イベント作成不可
        }
    }
    
    state 開発者モード {
        [*] --> 管理ホーム画面
        管理ホーム画面 --> キャンペーン管理
        キャンペーン管理 --> 詳細設定画面
        
        詳細設定画面 --> キャラクター管理: キャラクター編集
        詳細設定画面 --> タイムライン管理: イベント設計
        詳細設定画面 --> 世界観管理: 世界設定編集
        詳細設定画面 --> AI設定管理: AI 動作調整
        
        state "全機能アクセス" as 全機能 {
            キャラクター作成編集削除
            イベント作成編集削除
            タイムライン全操作
            システム設定変更
            データインポートエクスポート
            AI パラメータ調整
        }
    }
    
    note right of 一般モード: ユーザー向け\n簡単操作モード
    note right of 開発者モード: GM 向け\n高度設定モード
```

## テスト設計への活用

これらのワークフローは以下の E2E テスト設計に活用されます：

### 重要なテストパス
1. **ハッピーパス**: 一般ユーザーのセッション完了フロー
2. **エラーハンドリング**: 各種エラー状態の適切な処理
3. **状態管理**: モード切り替えと保存・復元
4. **AI統合**: AI 応答の非同期処理とタイムアウト処理

### テスト項目抽出
- 各フロー図の分岐点 → テストケース
- エラー状態 → 例外処理テスト
- 非同期処理 → タイミング・パフォーマンステスト
- 状態遷移 → データ整合性テスト

この図に基づいて、包括的な E2E テストスイートを構築し、TRPG システムの品質を保証します。

## 📝 補足説明

### ユーザーモードの違い

- **一般ユーザーモード**: TRPGセッションを楽しむことに特化。複雑な設定は隠蔽され、AIゲームマスターに従ってプレイ
- **開発者モード**: キャンペーン作成、詳細なイベント設定、AIパラメータ調整など、GM向けの全機能にアクセス可能

### 重要な画面遷移ポイント

1. **キャンペーン選択**: 全ての操作の起点
2. **セッション開始**: シングル/マルチプレイの分岐点
3. **イベント発生**: ゲーム進行の中核
4. **保存タイミング**: 自動保存と手動保存の使い分け

### エラー処理の優先順位

1. データの保護（緊急保存）
2. ユーザー体験の維持（代替処理）
3. 復旧可能性の確保（ログ・状態保存）
4. 明確なフィードバック（エラーメッセージ）